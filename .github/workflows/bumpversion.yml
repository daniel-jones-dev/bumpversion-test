name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump-type:
        description: 'Bump type'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch
      create-tag:
        description: 'Create tag'
        required: false
        default: false
        type: boolean

jobs:
  bump_version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Install bump-my-version
        run: |
          uv tool install bump-my-version

      - name: Bump version
        id: bump
        shell: bash
        run: |
          echo "previous-version=$(bump-my-version show current_version)" >> $GITHUB_OUTPUT
  
          bump-my-version bump ${{ inputs.bump-type }}
          ([[ $? -gt 0 ]] && echo "bumped=false" || echo "bumped=true") >> $GITHUB_OUTPUT
          echo "current-version=$(bump-my-version show current_version)" >> $GITHUB_OUTPUT

      - name: Update changelog
        id: changelog
        uses: release-flow/keep-a-changelog-action@v2
        with:
          command: bump
          version: ${{ inputs.bump-type }}
          keep-unreleased-section: true
          fail-on-empty-release-notes: true

      - name: Create branch and commit
        id: create_branch
        run: |
          git add .
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "docs: Increase version to ${{ steps.bump.outputs.current-version }}" \
            --author "${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>"
          
          if [[ ${{ inputs.create-tag }} == 'true' ]]; then
            git config --global user.name "${{ github.actor }}"
            git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
            git tag -m "Version ${{ steps.bump.outputs.current-version }}" v${{ steps.bump.outputs.current-version }}
            git push --tags
          fi

# TODO tag signing

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v7
        with:
          title: "Bump version to ${{ steps.bump.outputs.current-version }}"
          body: "This PR bumps the version to ${{ steps.bump.outputs.current-version }} and updates the changelog."
          branch: bumpversion-${{ steps.bump.outputs.current-version }}
          base: main
          token: ${{ secrets.GH_TOKEN }}

